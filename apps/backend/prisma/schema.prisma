generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  // url is now managed in prisma.config.ts and passed to PrismaClient constructor
  extensions = [vector]
}

enum DocumentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum FileFormat {
  pdf
  json
  txt
  md
  docx
  xlsx
  csv
  pptx
  html
  epub
}


enum SourceType {
  MANUAL
  DRIVE
}

enum SyncStatus {
  IDLE
  SYNCING
  ERROR
}

model Document {
  id          String         @id @default(uuid())
  filename    String
  mimeType    String         @map("mime_type")
  fileSize    Int            @map("file_size")
  format      FileFormat

  status      DocumentStatus @default(PENDING)
  filePath    String         @map("file_path")
  md5Hash     String         @unique @map("md5_hash")
  retryCount  Int            @default(0) @map("retry_count")
  failReason  String?        @map("fail_reason")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  // Phase 2: Content Export
  processedContent    String?   @db.Text @map("processed_content")
  // DEPRECATED: Use ProcessingMetrics relation instead
  processingMetadata  Json?     @map("processing_metadata")

  // Phase 2E: Drive Sync
  sourceType          SourceType    @default(MANUAL) @map("source_type")
  driveFileId         String?       @unique @map("drive_file_id")
  driveConfigId       String?       @map("drive_config_id")
  driveWebViewLink    String?       @map("drive_web_view_link")
  driveModifiedTime   DateTime?     @map("drive_modified_time")
  lastSyncedAt        DateTime?     @map("last_synced_at")

  // Phase 3: Data Management
  isActive        Boolean       @default(true) @map("is_active")
  connectionState String        @default("STANDALONE") @map("connection_state")

  // Phase 4: Format Expansion
  formatCategory  String?       @map("format_category")

  chunks              Chunk[]
  driveConfig         DriveConfig?  @relation(fields: [driveConfigId], references: [id], onDelete: SetNull)
  processingMetrics   ProcessingMetrics?
  
  // Phase 5: Processing Profile
  processingProfileId  String?  @map("processing_profile_id")
  processingProfile    ProcessingProfile? @relation(fields: [processingProfileId], references: [id], onDelete: SetNull)

  @@index([sourceType])
  @@index([driveConfigId])
  @@index([isActive])
  @@index([connectionState])
  @@index([formatCategory])
  @@index([processingProfileId])
  @@map("documents")
}

model Chunk {
  id          String   @id @default(uuid())
  documentId  String   @map("document_id")
  content     String
  chunkIndex  Int      @map("chunk_index")
  embedding   Unsupported("vector(384)")
  charStart   Int      @map("char_start")
  charEnd     Int      @map("char_end")
  page        Int?
  heading     String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Phase 4: Quality Metadata
  location       Json?     @db.JsonB
  qualityScore   Float?    @map("quality_score")
  qualityFlags   String[]  @map("quality_flags") @default([])
  chunkType      String?   @map("chunk_type")
  completeness   String?
  hasTitle       Boolean?  @map("has_title")
  breadcrumbs    String[]  @default([])
  tokenCount     Int?      @map("token_count")

  // Hybrid Search: BM25 full-text search vector
  searchVector   Unsupported("tsvector")?  @map("search_vector")

  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, chunkIndex])
  @@index([qualityScore])
  @@index([chunkType])
  @@index([searchVector], type: Gin)
  @@map("chunks")
}

model DriveConfig {
  id            String      @id @default(uuid())
  folderId      String      @unique @map("folder_id")
  folderName    String      @map("folder_name")
  syncCron      String      @default("0 */6 * * *") @map("sync_cron")
  recursive     Boolean     @default(true)
  enabled       Boolean     @default(true)
  lastSyncedAt  DateTime?   @map("last_synced_at")
  pageToken     String?     @map("page_token")
  syncStatus    SyncStatus  @default(IDLE) @map("sync_status")
  syncError     String?     @map("sync_error")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  documents     Document[]

  // Phase 5: Processing Profile
  processingProfileId  String?  @map("processing_profile_id")
  processingProfile    ProcessingProfile? @relation(fields: [processingProfileId], references: [id], onDelete: SetNull)

  @@index([enabled])
  @@index([processingProfileId])
  @@map("drive_configs")
}

// Phase 5: Analytics Dashboard - Processing Metrics
model ProcessingMetrics {
  id                String   @id @default(cuid())
  documentId        String   @unique @map("document_id")
  document          Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Migrated from processingMetadata JSON
  pageCount         Int      @default(0) @map("page_count")
  ocrApplied        Boolean  @default(false) @map("ocr_applied")
  
  // Queue & timing
  enqueuedAt        DateTime? @map("enqueued_at")
  startedAt         DateTime? @map("started_at")
  completedAt       DateTime? @map("completed_at")
  queueTimeMs       Int      @default(0) @map("queue_time_ms")
  
  // Processing time breakdown
  conversionTimeMs  Int      @default(0) @map("conversion_time_ms")
  chunkingTimeMs    Int      @default(0) @map("chunking_time_ms")
  embeddingTimeMs   Int      @default(0) @map("embedding_time_ms")
  totalTimeMs       Int      @default(0) @map("total_time_ms")
  userWaitTimeMs    Int      @default(0) @map("user_wait_time_ms")
  
  // Size metrics
  rawSizeBytes      Int      @default(0) @map("raw_size_bytes")
  markdownSizeChars Int      @default(0) @map("markdown_size_chars")
  
  // Chunking efficiency
  totalChunks       Int      @default(0) @map("total_chunks")
  avgChunkSize      Float    @default(0) @map("avg_chunk_size")
  oversizedChunks   Int      @default(0) @map("oversized_chunks")
  
  // Quality summary (aggregated from chunks)
  avgQualityScore   Float    @default(0) @map("avg_quality_score")
  qualityFlags      Json     @default("{}") @map("quality_flags")
  totalTokens       Int      @default(0) @map("total_tokens")
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  @@index([createdAt])
  @@map("processing_metrics")
}

// Phase 5: Processing Profile - Configurable pipeline settings
model ProcessingProfile {
  id           String   @id @default(cuid())
  name         String   @unique
  description  String?
  isActive     Boolean  @default(false) @map("is_active")
  isDefault    Boolean  @default(false) @map("is_default")
  isArchived   Boolean  @default(false) @map("is_archived")
  createdAt    DateTime @default(now()) @map("created_at")
  
  // === Stage 1: Conversion ===
  conversionTableRows    Int     @default(35)   @map("conversion_table_rows")
  conversionTableCols    Int     @default(20)   @map("conversion_table_cols")
  pdfOcrMode             String  @default("auto") @map("pdf_ocr_mode")
  pdfOcrLanguages        String  @default("en")   @map("pdf_ocr_languages")
  pdfNumThreads          Int     @default(4)    @map("pdf_num_threads")
  pdfTableStructure      Boolean @default(false) @map("pdf_table_structure")
  maxFileSizeMb          Int     @default(50)   @map("max_file_size_mb")
  
  // === Stage 2: Chunking ===
  documentChunkSize       Int @default(1000) @map("document_chunk_size")
  documentChunkOverlap    Int @default(100)  @map("document_chunk_overlap")
  documentHeaderLevels    Int @default(3)    @map("document_header_levels")
  presentationMinChunk    Int @default(200)  @map("presentation_min_chunk")
  tabularRowsPerChunk     Int @default(20)   @map("tabular_rows_per_chunk")
  
  // === Stage 3: Quality ===
  qualityMinChars         Int     @default(50)   @map("quality_min_chars")
  qualityMaxChars         Int     @default(2000) @map("quality_max_chars")
  qualityPenaltyPerFlag   Float   @default(0.15) @map("quality_penalty_per_flag")
  autoFixEnabled          Boolean @default(true) @map("auto_fix_enabled")
  autoFixMaxPasses        Int     @default(2)    @map("auto_fix_max_passes")
  
  // === Stage 4: Embedding (display-only, not editable) ===
  embeddingModel          String  @default("BAAI/bge-small-en-v1.5") @map("embedding_model")
  embeddingDimension      Int     @default(384) @map("embedding_dimension")
  embeddingMaxTokens      Int     @default(512) @map("embedding_max_tokens")
  
  documents     Document[]
  driveConfigs  DriveConfig[]
  
  @@map("processing_profiles")
}

