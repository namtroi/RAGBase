generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  // url is now managed in prisma.config.ts and passed to PrismaClient constructor
  extensions = [vector]
}

enum DocumentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum FileFormat {
  pdf
  json
  txt
  md
}

enum ProcessingLane {
  fast
  heavy
}

enum SourceType {
  MANUAL
  DRIVE
}

enum SyncStatus {
  IDLE
  SYNCING
  ERROR
}

model Document {
  id          String         @id @default(uuid())
  filename    String
  mimeType    String         @map("mime_type")
  fileSize    Int            @map("file_size")
  format      FileFormat
  lane        ProcessingLane
  status      DocumentStatus @default(PENDING)
  filePath    String         @map("file_path")
  md5Hash     String         @unique @map("md5_hash")
  retryCount  Int            @default(0) @map("retry_count")
  failReason  String?        @map("fail_reason")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  // Phase 2: Content Export
  processedContent    String?   @db.Text @map("processed_content")
  processingMetadata  Json?     @map("processing_metadata")

  // Phase 2E: Drive Sync
  sourceType      SourceType    @default(MANUAL) @map("source_type")
  driveFileId     String?       @unique @map("drive_file_id")
  driveConfigId   String?       @map("drive_config_id")
  lastSyncedAt    DateTime?     @map("last_synced_at")

  chunks        Chunk[]
  driveConfig   DriveConfig?  @relation(fields: [driveConfigId], references: [id], onDelete: SetNull)

  @@index([sourceType])
  @@index([driveConfigId])
  @@map("documents")
}

model Chunk {
  id          String   @id @default(uuid())
  documentId  String   @map("document_id")
  content     String
  chunkIndex  Int      @map("chunk_index")
  embedding   Unsupported("vector(384)")
  charStart   Int      @map("char_start")
  charEnd     Int      @map("char_end")
  page        Int?
  heading     String?
  createdAt   DateTime @default(now()) @map("created_at")

  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, chunkIndex])
  @@map("chunks")
}

model DriveConfig {
  id            String      @id @default(uuid())
  folderId      String      @unique @map("folder_id")
  folderName    String      @map("folder_name")
  syncCron      String      @default("0 */6 * * *") @map("sync_cron")
  recursive     Boolean     @default(true)
  enabled       Boolean     @default(true)
  lastSyncedAt  DateTime?   @map("last_synced_at")
  pageToken     String?     @map("page_token")
  syncStatus    SyncStatus  @default(IDLE) @map("sync_status")
  syncError     String?     @map("sync_error")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  documents     Document[]

  @@index([enabled])
  @@map("drive_configs")
}
